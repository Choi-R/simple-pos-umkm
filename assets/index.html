<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS - TOKO SETYA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        /* PRINT STYLES (Only needed here) */
        @media print {
            body>*:not(#receipt-to-print) {
                display: none !important;
            }

            #receipt-to-print {
                display: block !important;
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 5mm 5mm;
                font-family: 'Courier New', Courier, monospace;
                font-size: 10pt;
                color: #000;
                background-color: white;
            }

            #receipt-to-print .text-center {
                text-align: center;
            }

            #receipt-to-print .text-right {
                text-align: right;
            }

            #receipt-to-print .flex-between {
                display: flex;
                justify-content: space-between;
            }

            #receipt-to-print .bold {
                font-weight: bold;
            }

            #receipt-to-print .dashed-line {
                border-top: 1px dashed black;
                margin: 5px 0;
            }

            #receipt-to-print .big-total {
                font-size: 1.2em;
                font-weight: bold;
            }

            @page {
                margin: 0;
                size: auto;
            }
        }
    </style>
</head>

<body class="bg-slate-100 text-slate-800">

    <div class="container mx-auto max-w-lg min-h-screen flex flex-col">
        <header class="bg-white shadow-sm sticky top-0 z-10">
            <div class="p-4 text-center border-b">
                <h1 class="text-xl font-bold text-slate-900">TOKO SETYA</h1>
            </div>
            <div class="flex">
                <button onclick="switchTab('kasir')" id="tab-kasir"
                    class="flex-1 py-3 text-center text-sm font-bold border-b-2 border-blue-600 text-blue-600 bg-blue-50 transition-colors">
                    üõí KASIR
                </button>
                <button onclick="switchTab('admin')" id="tab-admin"
                    class="flex-1 py-3 text-center text-sm font-bold border-b-2 border-transparent text-slate-500 hover:text-slate-700 hover:bg-slate-50 transition-colors">
                    ‚öôÔ∏è ADMIN
                </button>
            </div>
        </header>

        <div class="p-4 flex flex-col flex-grow relative">

            <!-- KASIR VIEW -->
            <div id="view-kasir" class="flex flex-col flex-grow">
                <main class="bg-white rounded-xl shadow-md p-5 mb-4">
                    <div class="space-y-3">
                        <div class="relative group">
                            <input type="text" id="itemName" autocomplete="off" placeholder="Cari Barang..."
                                class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                onfocus="showDropdown()" oninput="filterDropdown()">
                            <div id="customDropdown"
                                class="absolute top-full left-0 w-full bg-white border border-t-0 rounded-b-lg shadow-xl max-h-60 overflow-y-auto z-50 hidden">
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <input type="text" id="itemQty" value="1" placeholder="Qty"
                                class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                onkeyup="formatInput(this)">
                            <input type="text" id="itemPrice" placeholder="Harga Jual"
                                class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                onkeyup="formatInput(this)">
                        </div>
                        <button onclick="addItem()"
                            class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 active:scale-95 transition-transform">
                            Tambah ke Keranjang
                        </button>
                    </div>
                </main>

                <section class="bg-white rounded-xl shadow-md p-5 flex-grow flex flex-col">
                    <h2 class="text-lg font-bold mb-2 border-b pb-2">Keranjang Belanja</h2>
                    <div id="itemList"
                        class="flex-grow space-y-2 overflow-y-auto custom-scrollbar pr-2 min-h-[150px] max-h-[300px]">
                        <p class="text-slate-400 text-center mt-4 text-sm">Keranjang kosong.</p>
                    </div>
                    <div class="mt-4 pt-4 border-t">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold">Total Tagihan</span>
                            <span id="totalDisplay" class="text-xl font-bold text-blue-600">Rp 0</span>
                        </div>
                        <div class="flex items-center gap-2 mb-4">
                            <label class="text-sm font-semibold w-24">Bayar:</label>
                            <input type="text" id="cashInput" placeholder="0"
                                class="flex-1 p-2 border rounded text-right font-mono" onkeyup="formatInput(this)"
                                oninput="calculateChange()">
                        </div>
                        <div class="flex justify-between items-center text-slate-600 text-sm">
                            <span>Kembali:</span>
                            <span id="changeDisplay" class="font-bold text-green-600">Rp 0</span>
                        </div>
                    </div>
                </section>

                <footer class="mt-4 space-y-3">
                    <div class="flex gap-2">
                        <button id="connectPrinterBtn" onclick="connectToPrinter()"
                            class="flex-1 bg-teal-600 text-white font-bold py-3 rounded-lg shadow hover:bg-teal-700 transition-colors flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z" />
                                <line x1="3" y1="6" x2="21" y2="6" />
                                <path d="M16 10a4 4 0 0 1-8 0" />
                            </svg>
                            <span id="printerStatusText">Sambung Printer</span>
                        </button>
                        <button id="printButton" onclick="handlePrint()"
                            class="flex-[2] bg-slate-800 text-white font-bold py-3 rounded-lg shadow-lg disabled:opacity-50"
                            disabled>
                            Cetak Struk
                        </button>
                    </div>
                    <p id="printerStatusMsg" class="text-xs text-center text-slate-500 hidden"></p>
                </footer>
            </div>

            <!-- ADMIN VIEW -->
            <div id="view-admin" class="flex flex-col flex-grow hidden">
                <div class="bg-white rounded-xl shadow-md p-5 mb-6">
                    <h2 class="text-lg font-bold mb-4 flex items-center gap-2">üì¶ Input Barang Baru</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Nama Barang</label>
                            <input type="text" id="adminName" placeholder="Contoh: Indomie Goreng"
                                class="w-full p-2 border rounded focus:ring-2 focus:ring-green-500">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Harga Beli</label>
                                <input type="text" id="adminBuyPrice" placeholder="0"
                                    class="w-full p-2 border rounded focus:ring-2 focus:ring-green-500"
                                    onkeyup="formatInput(this)">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Harga Jual</label>
                                <input type="text" id="adminSellPrice" placeholder="0"
                                    class="w-full p-2 border rounded focus:ring-2 focus:ring-green-500"
                                    onkeyup="formatInput(this)">
                            </div>
                        </div>
                        <button onclick="saveInventoryItem()"
                            class="w-full bg-green-600 text-white font-bold py-3 rounded hover:bg-green-700 active:scale-95 transition-transform">
                            Simpan Barang
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-md p-5 flex-grow">
                    <h2 class="text-lg font-bold mb-4 border-b pb-2">Daftar Barang</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-slate-500 uppercase bg-slate-50">
                                <tr>
                                    <th class="px-2 py-2">Nama</th>
                                    <th class="px-2 py-2 text-right">Beli</th>
                                    <th class="px-2 py-2 text-right">Jual</th>
                                    <th class="px-2 py-2 text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryTableBody">
                                <tr>
                                    <td colspan="4" class="text-center py-4 text-slate-400 italic">Belum ada data barang
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="receipt-to-print" class="hidden"></div>

    <script src="https://cdn.jsdelivr.net/npm/esc-pos-encoder@1.2.0/dist/esc-pos-encoder.min.js"></script>
    <script>
        const storeInfo = { name: "TOKO SETYA", address: "Beringin Asri Tengah 323 Semarang", phone: "08562669744" };
        const cashierName = "Setyowati";

        // --- BLUETOOTH PRINTER LOGIC ---
        let bluetoothDevice = null;
        let printCharacteristic = null;

        const printerStatusText = document.getElementById('printerStatusText');
        const printerStatusMsg = document.getElementById('printerStatusMsg');
        const connectBtn = document.getElementById('connectPrinterBtn');

        async function connectToPrinter() {
            if (bluetoothDevice && bluetoothDevice.gatt.connected) {
                if (confirm("Disconnect from printer?")) {
                    bluetoothDevice.gatt.disconnect();
                }
                return;
            }

            try {
                console.log('Requesting Bluetooth Device...');
                bluetoothDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ services: ['000018f0-0000-1000-8000-00805f9b34fb'] }], // Standard service for thermal printers
                    optionalServices: ['00001101-0000-1000-8000-00805f9b34fb'] // Serial Port Profile (SPP)
                });

                bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);

                console.log('Connecting to GATT Server...');
                const server = await bluetoothDevice.gatt.connect();

                console.log('Getting Service...');
                // Try to get the printing service
                const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');

                console.log('Getting Characteristic...');
                // Try standard characteristic
                printCharacteristic = await service.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb');

                console.log('Connected!');
                updatePrinterUI(true, bluetoothDevice.name);

            } catch (error) {
                console.error('Connection failed:', error);
                alert('Gagal koneksi: ' + error.message + '\n\nJika ini gagal terus, silakan gunakan tombol "Cetak" tanpa koneksi (via RawBT).');
                updatePrinterUI(false);
            }
        }

        function onDisconnected() {
            console.log('Disconnected from Bluetooth Device.');
            updatePrinterUI(false);
        }

        function updatePrinterUI(isConnected, name = '') {
            if (isConnected) {
                printerStatusText.textContent = "Printer OK";
                connectBtn.classList.remove('bg-teal-600', 'hover:bg-teal-700');
                connectBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                printerStatusMsg.textContent = `Terhubung ke: ${name}`;
                printerStatusMsg.classList.remove('hidden');
            } else {
                printerStatusText.textContent = "Sambung Printer";
                connectBtn.classList.add('bg-teal-600', 'hover:bg-teal-700');
                connectBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                printerStatusMsg.textContent = "";
                printerStatusMsg.classList.add('hidden');
                printCharacteristic = null;
                bluetoothDevice = null;
            }
        }

        // --- RECEIPT GENERATOR (EscPosEncoder) ---
        function generateReceiptBytes() {
            const encoder = new EscPosEncoder();
            const now = new Date();
            const dateStr = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;

            // Initialize encoder
            let receipt = encoder
                .initialize()
                .codepage('cp437') // Standard codepage
                .align('center')
                .bold(true)
                .size(2, 2)
                .line(storeInfo.name)
                .bold(false)
                .size('small')
                .line(storeInfo.address)
                .size('normal')
                .line(storeInfo.phone)
                .line('-'.repeat(30)) // 58mm usually ~30-32 chars
                .align('left')
                .line(`Tgl: ${dateStr}`)
                .line(`Ksr: ${cashierName}`)
                .line('-'.repeat(30));

            // Items
            cartItems.forEach(item => {
                // Formatting: "Qty x Price" on one line (if small) or separate?
                // Let's do:
                // Name
                // Qty x Price .......... Total
                receipt.line(item.name);

                const left = `${item.qty} x ${formatRp(item.price)}`;
                const right = formatRp(item.total);

                // Calculate spacing
                const spaceLen = 30 - left.length - right.length;
                const spaces = spaceLen > 0 ? ' '.repeat(spaceLen) : ' ';

                receipt.line(left + spaces + right);
            });

            receipt.line('-'.repeat(30));

            // Totals
            const total = parseFloat(document.getElementById('totalDisplay').dataset.value || 0);
            const cash = parseNumberInput(document.getElementById('cashInput').value);
            const change = cash - total;

            const addTotalLine = (label, val) => {
                const valStr = formatRp(val);
                const spaceLen = 30 - label.length - valStr.length;
                const spaces = spaceLen > 0 ? ' '.repeat(spaceLen) : ' ';
                receipt.line(label + spaces + valStr);
            };

            receipt.align('left'); // Simple left-right alignment with spaces
            addTotalLine('Total', total);
            addTotalLine('Bayar', cash);
            addTotalLine('Kembali', change);

            // Footer
            receipt
                .newline()
                .align('center')
                .line('Terima Kasih')
                .line('Barang yang sudah dibeli')
                .line('tidak dapat ditukar/dikembalikan')
                .newline()
                .newline()
                .newline() // Extra feed
                .cut();

            return receipt.encode();
        }

        // --- MAIN HANDLER ---
        async function handlePrint() {
            if (cartItems.length === 0) return;

            // 1. Generate Bytes
            let data = null;
            try {
                data = generateReceiptBytes();
            } catch (e) {
                console.error("Encoding error:", e);
                alert("Gagal encode struk: " + e.message);
                return;
            }

            // 2. Try Direct Bluetooth
            if (bluetoothDevice && bluetoothDevice.gatt.connected && printCharacteristic) {
                try {
                    // Send in SMALL chunks with DELAY
                    // Many BLE printers have small buffers and drop data if sent too fast
                    const MAX_CHUNK = 50;
                    for (let i = 0; i < data.length; i += MAX_CHUNK) {
                        const chunk = data.slice(i, i + MAX_CHUNK);
                        await printCharacteristic.writeValue(chunk);
                        // Small delay to allow printer to process/buffer
                        await new Promise(r => setTimeout(r, 50));
                    }
                    console.log("Direct print success");
                    return; // Done
                } catch (e) {
                    console.error("Bluetooth write failed in handlePrint:", e);
                    // Fall through to RawBT
                    alert("Gagal kirim ke Bluetooth langsung. Mencoba RawBT...");
                }
            }

            // 3. Fallback: RawBT
            try {
                // Convert Uint8Array to Base64
                // Efficient way for large arrays
                let binary = '';
                const len = data.byteLength;
                for (let i = 0; i < len; i++) {
                    binary += String.fromCharCode(data[i]);
                }
                const base64 = window.btoa(binary);

                // Redirect to RawBT
                window.location.href = 'rawbt:base64,' + base64;
                console.log("Sent to RawBT");
            } catch (e) {
                console.error("RawBT Catch:", e);
                alert("Gagal membuka RawBT: " + e.message);
            }
        }


        // COMMON UTILS
        const formatRp = (n) => new Intl.NumberFormat('id-ID', { maximumFractionDigits: 0 }).format(n);

        function formatInput(input) {
            // Remove non-digit characters
            let value = input.value.replace(/\D/g, '');
            if (value === '') {
                input.value = '';
                return;
            }
            // Add dots every 3 digits
            input.value = new Intl.NumberFormat('id-ID').format(parseInt(value));
        }

        function parseNumberInput(value) {
            if (!value) return 0;
            // Remove dots and convert to float
            return parseFloat(value.replace(/\./g, '')) || 0;
        }

        // --- NAVIGATION LOGIC ---
        function switchTab(tab) {
            const kasirView = document.getElementById('view-kasir');
            const adminView = document.getElementById('view-admin');
            const kasirTab = document.getElementById('tab-kasir');
            const adminTab = document.getElementById('tab-admin');

            const activeClass = "border-blue-600 text-blue-600 bg-blue-50".split(' ');
            const inactiveClass = "border-transparent text-slate-500 hover:text-slate-700 hover:bg-slate-50".split(' ');

            if (tab === 'kasir') {
                kasirView.classList.remove('hidden');
                adminView.classList.add('hidden');

                kasirTab.classList.add(...activeClass);
                kasirTab.classList.remove(...inactiveClass);
                adminTab.classList.remove(...activeClass);
                adminTab.classList.add(...inactiveClass);
            } else {
                kasirView.classList.add('hidden');
                adminView.classList.remove('hidden');

                adminTab.classList.add(...activeClass);
                adminTab.classList.remove(...inactiveClass);
                kasirTab.classList.remove(...activeClass);
                kasirTab.classList.add(...inactiveClass);

                renderInventory(dbInventory);
            }
        }

        // --- KASIR LOGIC ---
        let cartItems = [];
        let dbInventory = [];

        const kasirEls = {
            name: document.getElementById('itemName'),
            qty: document.getElementById('itemQty'),
            price: document.getElementById('itemPrice'),
            list: document.getElementById('itemList'),
            total: document.getElementById('totalDisplay'),
            cash: document.getElementById('cashInput'),
            change: document.getElementById('changeDisplay'),
            printBtn: document.getElementById('printButton'),
            receipt: document.getElementById('receipt-to-print')
        };

        // LOAD DATA FOR KASIR
        async function loadInventory() {
            try {
                const res = await fetch('/api/items');
                dbInventory = await res.json();
                renderInventory(dbInventory);

                // Removed datalist populating logic to support custom dropdown
                // dbInventory is already set above
            } catch (err) {
                console.error("Failed to load items", err);
            }
        }

        loadInventory(); // Run on startup

        // --- CUSTOM DROPDOWN LOGIC ---
        const dropdown = document.getElementById('customDropdown');

        function showDropdown() {
            renderDropdownItems(dbInventory);
            dropdown.classList.remove('hidden');
        }

        function hideDropdown() {
            // Small delay to allow click event to register
            setTimeout(() => {
                dropdown.classList.add('hidden');
            }, 200);
        }

        kasirEls.name.addEventListener('blur', hideDropdown);

        function filterDropdown() {
            const query = kasirEls.name.value.toLowerCase();
            const filtered = dbInventory.filter(item => item.name.toLowerCase().includes(query));
            renderDropdownItems(filtered);
            dropdown.classList.remove('hidden');
        }

        function renderDropdownItems(items) {
            dropdown.innerHTML = '';
            if (items.length === 0) {
                dropdown.classList.add('hidden'); // Hide if no items found
                return;
            }

            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'p-3 hover:bg-blue-50 cursor-pointer border-b last:border-b-0 flex justify-between items-center';
                div.innerHTML = `
                    <span class="font-medium text-slate-700">${item.name}</span>
                    <span class="text-sm text-slate-500">Rp ${formatRp(item.sell_price)}</span>
                `;
                // Mousedown fires before blur
                div.onmousedown = () => selectItem(item);
                dropdown.appendChild(div);
            });
        }

        function selectItem(item) {
            kasirEls.name.value = item.name;
            // Format price with dots for display in input
            kasirEls.price.value = formatRp(item.sell_price);
            kasirEls.qty.value = '1';
            kasirEls.qty.focus();

            dropdown.classList.add('hidden');
        }

        function addItem() {
            const name = kasirEls.name.value.trim();
            const qty = parseNumberInput(kasirEls.qty.value);
            const price = parseNumberInput(kasirEls.price.value);
            if (!name || qty <= 0 || isNaN(price)) return alert('Cek input kembali');
            cartItems.push({ name, qty, price, total: qty * price });
            renderCart();
            kasirEls.name.value = ''; kasirEls.qty.value = '1'; kasirEls.price.value = '';
        }

        function deleteItem(idx) { cartItems.splice(idx, 1); renderCart(); }

        function renderCart() {
            kasirEls.list.innerHTML = ''; let grandTotal = 0;
            if (cartItems.length === 0) kasirEls.list.innerHTML = '<p class="text-slate-400 text-center mt-4 text-sm">Keranjang kosong.</p>';
            cartItems.forEach((item, i) => {
                grandTotal += item.total;
                const row = document.createElement('div');
                row.className = 'flex justify-between items-center border-b border-slate-100 py-2 text-sm';
                row.innerHTML = `<div><div class="font-bold">${item.name}</div><div class="text-slate-500 text-xs">${item.qty} x ${formatRp(item.price)}</div></div><div class="text-right"><div>Rp ${formatRp(item.total)}</div><button onclick="deleteItem(${i})" class="text-red-500 text-xs">Hapus</button></div>`;
                kasirEls.list.appendChild(row);
            });
            kasirEls.total.textContent = 'Rp ' + formatRp(grandTotal);
            kasirEls.printBtn.disabled = cartItems.length === 0;
            kasirEls.total.dataset.value = grandTotal;
            calculateChange();
        }

        function calculateChange() {
            const total = parseFloat(kasirEls.total.dataset.value || 0);
            const cash = parseNumberInput(kasirEls.cash.value);
            const change = cash - total;
            kasirEls.change.textContent = cash > 0 ? 'Rp ' + formatRp(change) : 'Rp 0';
            kasirEls.change.className = change < 0 ? 'font-bold text-red-600' : 'font-bold text-green-600';
        }

        function printReceipt() {
            const now = new Date();
            // MANUAL DATE FORMATTING (Local Time)
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0'); // Months are 0-indexed
            const day = now.getDate().toString().padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;

            // MANUAL TIME FORMATTING (HH:MM:SS)
            const h = now.getHours().toString().padStart(2, '0');
            const m = now.getMinutes().toString().padStart(2, '0');
            const s = now.getSeconds().toString().padStart(2, '0');
            // This guarantees colons every time
            const timeStr = `${h}:${m}:${s}`;

            const total = parseFloat(kasirEls.total.dataset.value || 0);
            let totalQty = 0;
            // FIX: Use parseNumberInput to handle thousands separator dots correctly!
            const cash = parseNumberInput(kasirEls.cash.value);
            const change = cash - total;
            let itemsHtml = '';
            cartItems.forEach((item) => {
                totalQty += item.qty;
                itemsHtml += `<div style="margin-bottom: 5px;"><div class="bold">${item.name}</div><div class="flex-between"><span style="padding-left: 15px;">${item.qty} x ${formatRp(item.price)}</span><span>Rp ${formatRp(item.total)}</span></div></div>`;
            });
            const shopIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin: 0 auto 5px auto;"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg>`;
            const html = `<div class="text-center">${shopIcon}<div class="bold" style="font-size: 1.1em; margin-bottom:2px;">${storeInfo.name}</div><div style="font-size: 0.9em;">${storeInfo.address}</div><div style="font-size: 0.9em;">${storeInfo.phone}</div></div><div class="dashed-line"></div><div class="flex-between" style="font-size: 0.9em;"><div>${dateStr}<br>${timeStr}</div><div class="text-right">Ksr: ${cashierName}<br></div></div><div class="dashed-line"></div><div style="margin: 10px 0;">${itemsHtml}</div><div class="dashed-line"></div><div style="margin-top: 5px;"><div>Total QTY : ${totalQty}</div></div><div class="flex-between" style="margin-top: 5px;"><span>Sub Total</span><span>Rp ${formatRp(total)}</span></div><div class="flex-between big-total" style="margin: 5px 0;"><span>Total</span><span>Rp ${formatRp(total)}</span></div><div class="flex-between"><span>Bayar (Cash)</span><span>Rp ${formatRp(cash)}</span></div><div class="flex-between"><span>Kembali</span><span>Rp ${formatRp(change)}</span></div><div style="margin-top: 20px;" class="text-center">Terimakasih Telah Berbelanja</div>`;
            kasirEls.receipt.innerHTML = html;
            window.print();
        }
        kasirEls.price.addEventListener('keypress', (e) => { if (e.key === 'Enter') addItem(); });


        // --- ADMIN LOGIC ---
        const adminEls = {
            name: document.getElementById('adminName'),
            buy: document.getElementById('adminBuyPrice'),
            sell: document.getElementById('adminSellPrice'),
            table: document.getElementById('inventoryTableBody')
        };

        // Note: fetchItems called by switchTab when switching to admin

        async function fetchItems() {
            try {
                const res = await fetch('/api/items'); // Call backend
                const items = await res.json();
                dbInventory = items; // Update Global State
                renderInventory(items);
            } catch (err) {
                console.error('Fetch error:', err);
            }
        }

        async function saveInventoryItem() {
            const name = adminEls.name.value.trim();
            const buy = parseNumberInput(adminEls.buy.value);
            const sell = parseNumberInput(adminEls.sell.value);

            if (!name || isNaN(buy) || isNaN(sell)) return alert('Mohon lengkapi data barang');

            // OPTIMISTIC UPDATE: Update UI immediately
            const tempId = Date.now(); // Temporary ID until refresh
            const newItem = { id: tempId, name, buy_price: buy, sell_price: sell };

            // Update Local State
            dbInventory.push(newItem);
            renderInventory(dbInventory); // Update Admin Table

            // Clear Inputs immediately
            adminEls.name.value = ''; adminEls.buy.value = ''; adminEls.sell.value = ''; adminEls.name.focus();

            // SEND TO DATABASE (Background Sync)
            try {
                await fetch('/api/items', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, buy, sell })
                });
                // In a perfect world, we would replace the tempId with real ID here
                // But for simple use, we just let it sync on next page load or keeping it as is
            } catch (err) {
                alert('Gagal menyimpan ke server. Cek koneksi internet.');
                console.error(err);
                // Rollback state if needed, but for now we warn user
            }
        }

        async function deleteInventoryItem(id) {
            if (!confirm('Hapus barang ini?')) return;

            // OPTIMISTIC UPDATE
            const prevInventory = [...dbInventory]; // Backup for rollback
            dbInventory = dbInventory.filter(i => i.id !== id);
            renderInventory(dbInventory);

            // DELETE FROM DATABASE
            try {
                await fetch(`/api/items/${id}`, { method: 'DELETE' });
            } catch (err) {
                alert('Gagal menghapus dari server. Cek koneksi.');
                dbInventory = prevInventory; // Rollback
                renderInventory(dbInventory);
            }
        }

        function renderInventory(items) {
            adminEls.table.innerHTML = '';
            if (items.length === 0) {
                adminEls.table.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-slate-400 italic">Belum ada data barang</td></tr>';
                return;
            }
            items.forEach((item) => {
                const tr = document.createElement('tr');
                tr.className = "border-b hover:bg-slate-50";
                tr.innerHTML = `
                    <td class="px-2 py-2 font-medium">${item.name}</td>
                    <td class="px-2 py-2 text-right text-slate-500">${formatRp(item.buy_price)}</td>
                    <td class="px-2 py-2 text-right font-bold text-blue-600">${formatRp(item.sell_price)}</td>
                    <td class="px-2 py-2 text-center">
                        <button onclick="deleteInventoryItem(${item.id})" class="text-red-500 hover:text-red-700">üóëÔ∏è</button>
                    </td>
                `;
                adminEls.table.appendChild(tr);
            });
        }
    </script>
</body>

</html>